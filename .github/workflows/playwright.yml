name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    - name: Run Playwright tests
      run: npx playwright test
      continue-on-error: true
    - name: Prepare reports for upload
      if: ${{ !cancelled() }}
      run: |
        mkdir -p reports-bundle
        cp -r tests/*.html tests/*.json tests/history-runs reports-bundle/ 2>/dev/null || true
        cp -r report reports-bundle/ 2>/dev/null || true
        cp -r playwright-report reports-bundle/ 2>/dev/null || true
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: reports-bundle/
        retention-days: 30
  
  deploy:
    needs: test
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: playwright-report
        path: reports
    - name: Create index page
      run: |
        cat > reports/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>Playwright Test Reports</title>
          <style>
            body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
            h1 { color: #333; }
            .report-links { list-style: none; padding: 0; }
            .report-links li { margin: 15px 0; }
            .report-links a { display: inline-block; padding: 12px 24px; background: #0066cc; color: white; text-decoration: none; border-radius: 4px; }
            .report-links a:hover { background: #0052a3; }
          </style>
        </head>
        <body>
          <h1>Playwright Test Reports</h1>
          <ul class="report-links">
            <li><a href="smart-report.html">Smart Report (Detailed Analysis)</a></li>
            <li><a href="report/index.html">Ortoni Report</a></li>
            <li><a href="playwright-report/index.html">Standard Playwright Report</a></li>
          </ul>
        </body>
        </html>
        EOF
    - name: Setup Pages
      uses: actions/configure-pages@v4
    - name: Upload artifact to Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: reports
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
